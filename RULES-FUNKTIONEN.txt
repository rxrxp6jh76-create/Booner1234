^Regeln & Funktionen (Übersicht)
================================

Backend – KI-Trading
---------------------
- Plattform-Auswahl: Nur aktive Plattformen mit Symbol; Nutzung (Margin/Equity) wird bewertet; niedrigste Nutzung unter Limit bekommt den Trade; Konten ohne Balance werden als 100 % Nutzung behandelt.
- Plattform-Limit: combined_max_balance_percent_per_platform (Default 20 %) minus Buffer (budget_buffer_ratio, Default 20 %), effektiver Deckel 16 %; Sicherheitsabbruch, wenn alles über Limit liegt.
- Budget-Slicing: Rest-Budget wird auf budget_target_trades (Default 6) verteilt; pro Trade Cap budget_max_risk_per_trade_percent (Default 3 %); wenn kein Budget übrig, Trade-Abbruch.
- Cooldowns: Plattform-Asset-Cooldown (per-account) Standard 60 min, erhöht auf 120 min wenn Asset bereits offen; kürzere Skip bei Asset-Open.
- DB-Reservation: Plattform:Asset wird vor Order reserviert (TTL aus Setting), sonst Abbruch; Fallback auf in-memory möglich.
- Marktöffnungszeiten: Trade wird nur ausgeführt, wenn commodity_processor.is_market_open true.
- SL/TP-Modus: Prozent oder Euro je Strategie; dynamische SL/TP aus Analyse, falls vorhanden; tatsächliche Order ohne MT5-SL/TP, KI überwacht extern.
- Strategien: swing, day, scalping, mean_reversion, momentum, breakout, grid mit individuellen Risk-Defaults und ATR-Multiplikatoren.
- Lot-Berechnung: Stop-Loss-Pips aus Preisdistanz/pip_size, min 10 Pips; tick_value aus Symbol-Info (Fallback 10); Volumen via _calculate_lot_size_v2 (Balance * Risiko% / (SL-Pips * TickValue)) mit min 0.01, Modusabhängigem Max-Lot.
- Offene Positionen: Doppelvermeidung per has_open_position_for_commodity (gleiche Strategie/Symbol) und Count-Checks.
- Portfolio-Risiko-Check: Nutzung pro Plattform = Margin/Equity (Libertex-Formel) zum Logging; Abbruch bei Überschreitung des Limits in Auswahlphase.
- Trade-Logging: Umfangreiche Logs zu Auswahl, Budget, Volumen, SL/TP, Tickets.

Backend – multi_bot_system (Lot-Engine)
---------------------------------------
- _calculate_lot_size_v2: Modusabhängige Risiko-Stufen
  - conservative: <75 % kein Trade; 75–80 % 0.5 %; 80–88 % 0.75 %; >88 % 1.0 %; Max-Lot 1.5
  - neutral: <68 % kein Trade; 68–75 % 0.5 %; 75–85 % 1.0 %; >85 % 1.5 %; Max-Lot 2.0
  - aggressive: <60 % kein Trade; 60–68 % 1.0 %; 68–78 % 1.5 %; >78 % 2.0 %; Max-Lot 2.5
- Formel: Lots = (Balance * Risiko%) / (SL-Pips * TickValue), gerundet, min 0.01, capped per Modus.

Backend – Market Hours / Assets
-------------------------------
- Market-Hours aus /market/hours/all; pro Asset: enabled, days, open/close, Presets (24/7, 24/5, Börse).
- Kategorien: commodity_category / category aus COMMODITIES für Gruppierung/Filter.

Backend – AI Trading Functions (Chat-Tools)
-------------------------------------------
- Funktionsliste: execute_trade, close_trade, close_all_trades, close_trades_by_symbol, get_open_positions, update_stop_loss für AI-Calls.
- execute_trade: wählt Plattform (erstes active_platform oder MT5_LIBERTEX), nutzt latest_market_data Preis, berechnet Menge bei fehlender Angabe (Default Balance 10k, 2 % Risiko, falls SL vorhanden via Preisabstand), legt Trade in DB an (status OPEN, executed_by AI_CHAT) ohne echte Plattform-Order.
- close_all_trades: holt aktive Plattformen aus trading_settings, schließt MT5-Positionen via MultiPlatformConnector und setzt DB-Trades auf CLOSED; by_symbol nutzt COMMODITY_MAPPINGS für MT5-Symbole.
- get_open_positions: liefert offene DB-Trades inkl. Peak-Daten aus autonomous_trading.active_risk_circuits (peak_profit, progress, elapsed_min) und Textzusammenfassung.
- update_stop_loss: setzt SL im DB-Trade; close_trade markiert Trade CLOSED mit Timestamp.

Backend – AI Position Manager
-----------------------------
- Aktiv nur wenn settings.use_ai_analysis true; überwacht alle OPEN Trades (auch manuell) mit current_prices.
- Dynamische SL/TP pro Trade aus AKTUELLEN Settings (nicht aus Trade gespeichert): Strategien day/swing, Modi euro oder percent; Euro→Punkte via lot_multiplier (quantity/0.01), Percent über entry_price.
- Rechnet SL/TP pro Richtung (BUY: SL=entry-sl_points; SELL: SL=entry+sl_points usw.), loggt Berechnung.
- Schließt Position wenn current_price TP erreicht bzw. SL unterschreitet/überschreitet; Trendwende-Logik und frühe Gewinnmitnahmen sind deaktiviert (V2.5.1).
- Beim Schließen: setzt status CLOSED, exit_price, profit_loss (BUY: (current-entry)*qty; SELL invers), closed_at, strategy_signal.

Backend – Autonomous Trading Intelligence (Risk Circuit)
-------------------------------------------------------
- Trackt peak_progress_percent und peak_profit pro Trade.
- 50%-TP erreicht ⇒ SL auf Breakeven (Entry ± Spread-Puffer 1 %), einmalig.
- Profit-Drawdown-Exit: Nach ≥30 Minuten, wenn Gewinn ≥10 % unter Peak fällt (profit_drawdown_ratio ≥ 0.10) → profit_drawdown_exit; Fallback auf Progress-Drawdown gleicher Schwelle, wenn Profit nicht verfügbar.

Backend – AI Chat Service / Tools
---------------------------------
- Kontextgenerator: beschreibt Auto-Trading, AI-Analyse, Trailing Stop (Distanz), alle 7 Strategien mit Min-Confidence und SL/TP-Defaults; listet Marktdaten inkl. market_open-Status und offene Trades (max 10) mit empfohlenen SL/TP je Strategie.
- Ausführbare Tools: execute_trade_tool (Markt-open-Check, default_platform aus settings, MT5-Symbolmapping, Market-Order ohne SL/TP), close_trade_tool, close_all_trades_tool, close_trades_by_symbol_tool (MT5-Mappings), get_open_positions_tool (aggregiert Plattform-Positionen), toggle_strategy_tool (setzt *_enabled), toggle_auto_trading_tool (setzt auto_trading), update_sl_tp_tool (setzt Strategie-SL/TP Keys), get_portfolio_summary_tool (Balance/Equity/PnL aggregiert über MT5_LIBERTEX/ICMARKETS).
- Chat-Init: Provider/Model per settings; System-Prompt erlaubt direkte Aktionen trotz Auto-Trading-Status; nutzt API-Keys pro Provider oder emergent Fallback.
- handle_trading_actions: Keyword-Erkennung in User-Message (z.B. „schließe alle“, „kaufe Gold“, Strategien an/aus, Auto-Trading an/aus, Portfolio) und führt Tools direkt aus (Standardmenge 0.01 Lots); unterstützt Close nur profitable/negative Trades über multi_platform.
- send_chat_message: hängt Kontext nur an Nicht-Bestätigungen an; prüft nach Antwort erneut auf Aktionen und appendet Aktions-Resultate.

Backend – AI Routes (FastAPI)
-----------------------------
- /ai/weight-history: Historie aus pillar_weights_history (Fallback Demo-Eintrag) nach Asset/Limit.
- /ai/pillar-efficiency: Effizienz-Scores aus booner_intelligence_engine (Fallback neutrale 50er Werte).
- /ai/auditor-log: letzte Entscheidungen aus engine.auditor_log (timestamp, asset, original/final_action, blocked, red_flags, reasoning, confidence).
- /ai/spread-analysis: trade_settings mit spread; klassifiziert spread_status (EXCELLENT <0.1 %, ACCEPTABLE <0.3 %, HIGH <0.5 %, sonst EXTREME) und sl_adjustment_percent = spread_percent*1.5 wenn SL vorhanden.
- /ai/learning-stats: Bayesian Self-Learning Stats (optimizations, win_rate, assets, weight drift, pillar performance) mit Fallback-Defaults.
- /ai/learn-from-trade: ruft engine.learn_from_trade_result auf; gibt weight_changes und Profit-Flag zurück.
- /ai/pillar-efficiency-detailed: Effizienz + weight_history, Empfehlung basierend auf best/worst pillar; Fallback liefert neutrale Werte.
- /ai/trigger-optimization: startet engine.optimize_weights_for_asset(asset) oder optimize_all_weights.

Frontend – Dashboard
--------------------
- Tab „Assets“ statt „Rohstoffe“.
- Kategorie-Filter: Dropdown über erkannte Kategorien; zeigt gefilterte Anzahl vs. Gesamt.
- Sortierung: Assets werden nach KI-Confidence (signalsStatus) absteigend sortiert in Cards und Charts.
- Asset-Grids: Nutzen gefilterte+sortierte Liste; Chart-Grid identisch.

Wesentliche Settings (Defaults)
-------------------------------
- combined_max_balance_percent_per_platform: 20
- budget_buffer_ratio: 0.20
- budget_target_trades: 6
- budget_max_risk_per_trade_percent: 3

Tests (manuell vorschlagbar)
----------------------------
- UI: Kategorie-Filter wählen, prüfen Sortierung (höchste Confidence oben) in Cards/Charts.
- Budget: Logs prüfen, dass risk_per_trade <= Cap und Rest/Slots gerechnet wird; Abbruch wenn kein Budget.
- Plattformwahl: Logs prüfen Platform candidates, Nutzung < Limit; Konten ohne Balance werden übersprungen.
- Lot: SL-Pips > 10, TickValue geladen; Volumen innerhalb Symbol-Min/Max.
